# Инструкция по использованию системы маршрутов

## Обзор
Ваше приложение использует систему построения маршрутов между отделениями доставки. Маршруты строятся по дорогам с использованием данных OpenStreetMap через OSRM API.

## Как работает система

1. При выборе двух отделений (отправки и получения) в калькуляторе доставки
2. Система сначала проверяет наличие готового маршрута в базе данных
3. Если маршрут уже существует, он отображается сразу
4. Если маршрута нет в базе, система обращается к OSRM API для получения реального маршрута по дорогам
5. Рассчитанный маршрут сохраняется в базе данных для последующего использования

## Решение проблемы "Построение маршрута невозможно"

Если вы видите ошибку "Построение маршрута невозможно. Проверьте соединение с интернетом", это может быть связано с:

1. **Ограничениями публичного OSRM API** - публичные сервера могут ограничивать количество запросов
2. **Проблемами с CORS** - ограничениями между доменами
3. **Временным недоступностью сервиса**

## Улучшения в вашей системе

1. **Улучшенная обработка запросов** - добавлены заголовки User-Agent и увеличено время ожидания
2. **Обратная совместимость** - если маршрут по дорогам недоступен, используется прямая линия как резервный вариант
3. **Кэширование маршрутов** - все рассчитанные маршруты сохраняются в базе данных
4. **Поддержка двусторонних маршрутов** - маршрут A->B автоматически работает и для B->A

## Запуск предварительного расчета маршрутов

Для улучшения производительности и уменьшения зависимости от внешнего API, вы можете предварительно рассчитать маршруты между всеми отделениями:

```bash
php populate_routes.php
```

Этот скрипт:
- Рассчитывает прямолинейные расстояния между всеми парами отделений
- Сохраняет результаты в базу данных
- Ускоряет последующие запросы маршрутов

## Технические детали

- **Frontend**: JavaScript с библиотекой Leaflet и Leaflet.PolylineUtil
- **Backend**: PHP скрипт `get_route.php` 
- **База данных**: Таблица `calculated_routes` для хранения маршрутов
- **API**: Публичный OSRM сервер (router.project-osrm.org)

## Возможные улучшения

Для более стабильной работы в продакшене рекомендуется:

1. **Локальный OSRM сервер** - запуск собственного экземпляра OSRM для Беларуси
2. **Ограничение частоты запросов** - реализация очереди запросов
3. **Резервные API** - использование альтернативных сервисов маршрутизации

## Отладка

При возникновении проблем с маршрутами:
1. Проверьте консоль браузера (F12) на наличие ошибок
2. Убедитесь, что координаты отделений в базе данных корректны
3. Проверьте соединение с интернетом
4. Проверьте логи Apache/Nginx на наличие ошибок PHP